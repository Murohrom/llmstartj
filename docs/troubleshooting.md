# Руководство по устранению неполадок

## Общие проблемы

### 1. Бот не отвечает

**Симптомы:**
- Бот не реагирует на команды
- Нет логов активности

**Возможные причины:**
- Неправильный токен бота
- Бот заблокирован
- Проблемы с сетью

**Решение:**
1. Проверьте правильность `TELEGRAM_BOT_TOKEN`
2. Убедитесь, что бот не заблокирован пользователем
3. Проверьте логи на наличие ошибок
4. Перезапустите бота

### 2. Ошибки API OpenRouter

**Симптомы:**
- Сообщения "Хм... Что-то с интернетом"
- Ошибки в логах связанные с API

**Возможные причины:**
- Неправильный API ключ
- Исчерпан баланс
- Превышены лимиты запросов

**Решение:**
1. Проверьте правильность `OPENROUTER_API_KEY`
2. Проверьте баланс на [OpenRouter](https://openrouter.ai/)
3. Увеличьте `MAX_RETRIES` и `RETRY_DELAY`
4. Проверьте лимиты запросов

### 3. Проблемы с Docker

**Симптомы:**
- Ошибки при сборке образа
- Контейнер не запускается

**Решение:**
```bash
# Очистка Docker
docker system prune -a

# Пересборка образа
docker-compose build --no-cache

# Проверка логов
docker-compose logs anime-bot
```

### 4. Проблемы с переменными окружения

**Симптомы:**
- Ошибки валидации конфигурации
- Бот не запускается

**Решение:**
1. Проверьте наличие всех обязательных переменных
2. Убедитесь, что файл `.env` существует
3. Проверьте синтаксис переменных

## Проблемы с логированием

### 1. Логи не записываются

**Решение:**
1. Проверьте права доступа к папке `logs/`
2. Убедитесь, что `LOG_LEVEL` установлен правильно
3. Проверьте свободное место на диске

### 2. Слишком много логов

**Решение:**
1. Установите `LOG_LEVEL=WARNING`
2. Настройте ротацию логов
3. Очистите старые логи

## Проблемы с кэшированием

### 1. Кэш не работает

**Симптомы:**
- Повторные запросы к API
- Медленные ответы

**Решение:**
1. Проверьте права доступа к папке `data/cache/`
2. Убедитесь, что `CACHE_TTL` установлен правильно
3. Проверьте свободное место на диске

### 2. Кэш занимает много места

**Решение:**
1. Уменьшите `CACHE_TTL`
2. Очистите старые файлы кэша
3. Настройте автоматическую очистку

## Проблемы с пагинацией

### 1. Кнопки пагинации не работают

**Симптомы:**
- Кнопки не реагируют на нажатия
- Ошибки в логах

**Решение:**
1. Проверьте, что обработчик пагинации зарегистрирован
2. Убедитесь, что callback данные корректны
3. Проверьте логи на ошибки

### 2. Пагинация сбрасывается

**Решение:**
1. Проверьте, что `PaginationService` инициализирован
2. Убедитесь, что состояние сохраняется в памяти
3. Проверьте, что нет конфликтов между пользователями

## Проблемы с производительностью

### 1. Медленные ответы

**Возможные причины:**
- Медленное API OpenRouter
- Большой контекст диалога
- Недостаточно ресурсов

**Решение:**
1. Увеличьте `MAX_RETRIES` и `RETRY_DELAY`
2. Уменьшите размер контекста диалога
3. Проверьте ресурсы сервера

### 2. Высокое потребление памяти

**Решение:**
1. Уменьшите размер контекста диалога
2. Настройте очистку старых состояний
3. Мониторьте использование памяти

## Проблемы с деплоем

### 1. Railway

**Проблемы:**
- Ошибки сборки
- Неправильные переменные окружения

**Решение:**
1. Проверьте логи сборки в Railway
2. Убедитесь, что все переменные окружения установлены
3. Проверьте, что Dockerfile корректен

### 2. Render

**Проблемы:**
- Ошибки при деплое
- Сервис не запускается

**Решение:**
1. Проверьте настройки Build Command и Start Command
2. Убедитесь, что порт настроен правильно
3. Проверьте логи в веб-интерфейсе Render

### 3. Heroku

**Проблемы:**
- Ошибки при push
- Приложение не запускается

**Решение:**
1. Проверьте, что Heroku CLI установлен
2. Убедитесь, что все переменные окружения установлены
3. Проверьте логи: `heroku logs --tail`

## Мониторинг и диагностика

### 1. Проверка состояния бота

```bash
# Docker Compose
docker-compose ps

# Docker
docker ps

# Проверка логов
docker-compose logs anime-bot
```

### 2. Проверка переменных окружения

```bash
# Docker Compose
docker-compose exec anime-bot env

# Docker
docker exec anime-bot env
```

### 3. Проверка файловой системы

```bash
# Проверка кэша
docker-compose exec anime-bot ls -la /app/data/cache/

# Проверка логов
docker-compose exec anime-bot ls -la /app/logs/
```

## Профилактика проблем

### 1. Регулярное обслуживание

- Мониторинг логов
- Очистка старых файлов
- Обновление зависимостей
- Проверка баланса API

### 2. Резервное копирование

- Регулярное резервное копирование кэша
- Сохранение конфигурации
- Документирование изменений

### 3. Мониторинг

- Настройка алертов
- Отслеживание метрик
- Регулярные проверки работоспособности

## Получение помощи

Если проблема не решается:

1. Проверьте логи на наличие ошибок
2. Соберите информацию о проблеме
3. Создайте issue в репозитории
4. Опишите шаги для воспроизведения проблемы
