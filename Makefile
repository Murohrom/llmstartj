# Makefile –¥–ª—è –°–∞–π—Ç–∞–º–∞ –ë–æ—Ç–∞ - LLM-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –∞–Ω–∏–º–µ
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç uv –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ –∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ–º

.PHONY: help install dev run stop test clean lint format check

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
PYTHON_FILES = src/ tests/
PID_FILE = .bot.pid

# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@echo "  install    - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  dev        - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
	@echo "  run        - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
	@echo "  stop       - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞"
	@echo "  test       - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã"
	@echo "  lint       - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ —Å –ø–æ–º–æ—â—å—é flake8 –∏ mypy"
	@echo "  format     - –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ —Å –ø–æ–º–æ—â—å—é black –∏ isort"
	@echo "  check      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ (lint + test)"
	@echo "  clean      - –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo ""

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
install:
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	uv sync --no-dev

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
dev:
	@echo "üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏..."
	uv sync

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
run:
	@echo "ü§ñ –ó–∞–ø—É—Å–∫ –°–∞–π—Ç–∞–º–∞ –ë–æ—Ç–∞..."
	@if [ -f $(PID_FILE) ]; then \
		echo "‚ö†Ô∏è  –ë–æ—Ç —É–∂–µ –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(PID_FILE)))"; \
		echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'make stop' –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"; \
		exit 1; \
	fi
	@echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ .env —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å —Ç–æ–∫–µ–Ω–æ–º Telegram –±–æ—Ç–∞!"
	uv run python src/bot.py & echo $$! > $(PID_FILE)
	@echo "‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω (PID: $$(cat $(PID_FILE)))"
	@echo "üìù –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: make stop"

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
stop:
	@if [ ! -f $(PID_FILE) ]; then \
		echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"; \
		exit 1; \
	fi
	@echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞..."
	@PID=$$(cat $(PID_FILE)); \
	if kill -0 $$PID 2>/dev/null; then \
		kill $$PID; \
		echo "‚úÖ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (PID: $$PID)"; \
	else \
		echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å —Å PID $$PID –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
	fi
	@rm -f $(PID_FILE)

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
test:
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	uv run python -m pytest tests/ -v --tb=short

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω—Ç–µ—Ä–æ–≤
lint:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
	@echo "–ó–∞–ø—É—Å–∫ flake8..."
	uv run flake8 $(PYTHON_FILES)
	@echo "–ó–∞–ø—É—Å–∫ mypy..."
	uv run mypy $(PYTHON_FILES)

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
format:
	@echo "‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	@echo "–ó–∞–ø—É—Å–∫ isort..."
	uv run isort $(PYTHON_FILES)
	@echo "–ó–∞–ø—É—Å–∫ black..."
	uv run black $(PYTHON_FILES)

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (–ª–∏–Ω—Ç–∏–Ω–≥ + —Ç–µ—Å—Ç—ã)
check: lint test
	@echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -f $(PID_FILE)
	rm -rf .coverage htmlcov/
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞
status:
	@if [ -f $(PID_FILE) ]; then \
		PID=$$(cat $(PID_FILE)); \
		if kill -0 $$PID 2>/dev/null; then \
			echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (PID: $$PID)"; \
		else \
			echo "‚ùå PID —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"; \
			rm -f $(PID_FILE); \
		fi \
	else \
		echo "‚ùå –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω"; \
	fi

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
restart: stop run
	@echo "üîÑ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
